name: Unit Test
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  deploy:
    name: Running unit tests
    runs-on: macos-13
    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s '/Applications/Xcode_15.0.1.app/Contents/Developer'
        
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Get current date
        run: echo "NOW=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: "swift"

      - name: Test
        run: xcodebuild test -scheme KukaiCoreSwift -sdk iphonesimulator -destination "platform=iOS Simulator,OS=16.4,name=iPhone 14 Pro" -enableCodeCoverage YES -resultBundlePath "$PWD/xcode-${{NOW}}.xcresult"

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:swift"
      
      - name: Upload results
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v3.1.3
        with:
          name: "results-${{NOW}}.xcresult"
          path: "$PWD/xcode-${{NOW}}.xcresult"









# Checkout the code, and run mxcl's xcodebuild action to run the unit tests
# jobs:
#   build:
#     runs-on: macos-13
#     strategy:
#       matrix:
#         platform:
#           - iOS
#         xcode:
#           - ^15
#     steps:
#       - uses: actions/checkout@v4.1.1

#       - name: Initialize CodeQL
#         uses: github/codeql-action/init@v2
#         with:
#           languages: "swift"

#       - uses: mxcl/xcodebuild@v2.0
#         with:
#           platform: ${{ matrix.platform }}
#           xcode: ${{ matrix.xcode }}
#           action: test
#           scheme: KukaiCoreSwift
#           code-coverage: true
#           upload-logs: always

#       - name: Perform CodeQL Analysis
#         uses: github/codeql-action/analyze@v2
#         with:
#           category: "/language:swift"
      
      #- name: Test
      #  run: xcodebuild -scheme KukaiCoreSwift test -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 12' -enableCodeCoverage YES -resultBundlePath "../../xcode-$GITHUB_RUN_ID.xcresult"
      #
      #- name: Upload results
      #  uses: actions/upload-artifact@v2
      #  with:
      #    name: "results-$GITHUB_RUN_ID.xcresult"
      #    path: "/Users/runner/work/xcode-$GITHUB_RUN_ID.xcresult"
