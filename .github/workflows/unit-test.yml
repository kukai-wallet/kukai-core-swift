name: Unit Test
on:
  push:
    branches:
      - main
      - develop
      - feature/shared_ci_test
  pull_request:
    branches:
      - main
      - develop

jobs:
  setup:
    uses: kukai-wallet/ios_shared_ci/.github/workflows/shared_setup.yml@main
    
  test:
    name: Running unit tests
    needs: setup
    runs-on: ${{ fromJSON(needs.setup.outputs.IOS_SHARED_SETUP_RUNS_ON) }}
    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s ${{ needs.setup.outputs.IOS_SHARED_SETUP_XCODE_VERSION }}
        
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Get current date
        run: echo "NOW=$(date +'%Y-%m-%dT%H-%M-%S')" >> $GITHUB_ENV

      - name: Test
        run: xcodebuild test -scheme KukaiCoreSwift -destination ${{ needs.setup.outputs.IOS_SHARED_SETUP_SIMULATOR_VERSION }} -enableCodeCoverage YES -resultBundlePath "~/xcode-$NOW.xcresult"

      - name: Upload results
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4.3.1
        with:
          name: "results-${{ env.NOW }}.xcresult"
          path: "~/xcode-${{ env.NOW }}.xcresult"
      